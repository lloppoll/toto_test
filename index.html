<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í† í† ì¸í…Œë¦¬ì–´ ë§ˆìŠ¤í„° ê²¬ì  ì‹œìŠ¤í…œ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; color: #0f172a; margin: 0; padding: 0; }
        :root { --toto-navy: #0f172a; --toto-blue: #2563eb; --toto-slate: #64748b; }
        
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .category-tab.active { background-color: var(--toto-blue); color: white; border-color: var(--toto-blue); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25); }
        .m-card { transition: all 0.2s ease-out; }
        .sortable-ghost { opacity: 0.1; background-color: #eff6ff !important; border: 2px dashed #3b82f6 !important; }
        
        .print-page { width: 210mm; min-height: 297mm; height: auto; padding: 20mm; margin: 40px auto; background: white; border: 1px solid #e2e8f0; position: relative; display: flex; flex-direction: column; overflow: visible; }

        @media print { 
            .no-print { display: none !important; } 
            body { background: white; margin: 0; padding: 0; } 
            .print-page { margin: 0; padding: 15mm; width: 210mm; height: 296.5mm; border: none; page-break-after: always; overflow: hidden; display: flex; box-shadow: none; } 
            .print-page.auto-height { height: auto !important; min-height: 296.5mm; overflow: visible !important; display: block !important; page-break-after: auto; }
            .detail-table tbody { page-break-inside: avoid !important; break-inside: avoid-page !important; }
            .detail-table tr { page-break-inside: avoid; break-inside: avoid; }
            .detail-table thead { display: table-header-group; } 
            .print-page:last-child { page-break-after: avoid; } 
        }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--toto-blue); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .wrap-text { word-break: break-all; white-space: normal; }
        .provider-label { width: 80px; font-weight: 800; color: #64748b; font-size: 11px; text-align: left; }
        .page-header-title { font-size: 1.5rem; font-weight: 900; letter-spacing: -0.02em; border-bottom: 3px solid var(--toto-navy); padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
        .detail-table th { background-color: #f8fafc; border: 1px solid #94a3b8; padding: 10px 4px; font-weight: 800; font-size: 11px; }
        .detail-table td { border: 1px solid #cbd5e1; padding: 8px 6px; font-size: 11px; }
        .subtotal-row { background-color: #f9fafb; font-weight: 800; }
        .category-row { background-color: #fdfdfd; font-weight: 900; color: var(--toto-blue); border-top: 2px solid var(--toto-navy); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .area-type-btn.active { background-color: var(--toto-blue) !important; color: white !important; border-color: var(--toto-blue) !important; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25); }
    </style>
</head>
<body class="antialiased overflow-x-hidden">
    <div class="no-print flex flex-col">
        <nav class="bg-[#0f172a] text-white p-4 sticky top-0 z-50 shadow-xl">
            <div class="max-w-[1800px] mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-black italic tracking-tighter shrink-0">TOTO <span class="text-blue-500 font-bold uppercase">Pro</span></h1>
                    <div class="h-6 w-px bg-slate-700 hidden sm:block"></div>
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest hidden lg:inline">v11.0 Master Final</span>
                </div>
                <div class="flex items-center space-x-6">
                    <div id="sync-status" class="hidden text-[10px] bg-green-500/20 text-green-400 px-3 py-1 rounded-full border border-green-500/30 font-bold shrink-0">â— CLOUD CONNECTED</div>
                    <button onclick="app.saveToLocal()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-xl font-bold text-xs transition-all shadow-lg shrink-0">ì €ì¥</button>
                    <button onclick="app.loadFromLocal()" class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded-xl font-bold text-xs transition-all shadow-lg shrink-0">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <div class="text-right hidden md:block shrink-0">
                        <div class="text-[10px] font-bold text-slate-500 uppercase">Estimated Total</div>
                        <div id="nav-total" class="text-xl lg:text-2xl font-black text-white">0ì›</div>
                    </div>
                    <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2.5 rounded-xl font-bold text-sm transition-all shadow-lg shrink-0">ê³µì‹ ê²¬ì ì„œ ë°œí–‰</button>
                </div>
            </div>
        </nav>
        <main class="max-w-[1800px] mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8 w-full">
            <div class="lg:col-span-8 space-y-6 min-w-0">
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-200 grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
                    <div class="md:col-span-2 space-y-4 min-w-0">
                        <div class="min-w-0">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">í˜„ì¥ ì£¼ì†Œ / ê³ ê°ëª…</label>
                            <input type="text" id="site-name" value="" oninput="app.debounceUpdate()" class="w-full mt-1 bg-slate-50 border-none rounded-xl p-4 font-bold text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none wrap-text">
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="col-span-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">ê³µì‚¬ í‰ìˆ˜</label>
                                <div class="relative">
                                    <input type="number" id="site-size" value="" onchange="app.syncAutoCalculations()" oninput="app.updateActualSizeDisplay()" class="w-full mt-1 bg-slate-50 border-none rounded-xl p-4 font-bold text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none">
                                    <span class="absolute right-4 top-5 text-xs font-bold text-slate-400">í‰</span>
                                </div>
                            </div>
                            <div class="col-span-2 space-y-2">
                                <div>
                                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">ë©´ì  ì‚°ì¶œ íƒ€ì…</label>
                                    <div class="flex gap-2 mt-1">
                                        <button onclick="app.setAreaType('normal')" id="area-type-normal" class="flex-1 area-type-btn active bg-blue-500 text-white border-2 border-blue-500 rounded-xl p-2.5 font-bold text-[10px] transition-all">
                                            ğŸ“ ë¹„í™•ì¥
                                        </button>
                                        <button onclick="app.setAreaType('extended')" id="area-type-extended" class="flex-1 area-type-btn bg-white text-slate-600 border-2 border-slate-200 rounded-xl p-2.5 font-bold text-[10px] transition-all hover:bg-slate-50">
                                            ğŸ“ í™•ì¥í˜•
                                        </button>
                                        <button onclick="app.setAreaType('high')" id="area-type-high" class="flex-1 area-type-btn bg-white text-slate-600 border-2 border-slate-200 rounded-xl p-2.5 font-bold text-[10px] transition-all hover:bg-slate-50">
                                            ğŸ—ï¸ ê³ ì¸µê³ 
                                        </button>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-[9px] font-bold text-slate-500 shrink-0">ë©´ì  ê³„ìˆ˜:</label>
                                    <input type="number" id="area-multiplier" value="1.0" step="0.1" min="0.5" max="2.0" onchange="app.updateAreaMultiplier()" class="flex-1 bg-white border border-slate-200 rounded-lg p-1.5 text-center font-bold text-xs outline-none">
                                    <span class="text-[9px] font-bold text-slate-400">ì‹¤ì œ: <span id="actual-size-display" class="text-blue-600 font-black">0</span>í‰</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-50 rounded-2xl p-6 space-y-3 border border-slate-100 shrink-0">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] font-bold text-slate-500">ê²½ë¹„(%)</label>
                                <input type="number" id="rate-exp" value="5" oninput="app.debounceUpdate()" class="w-full mt-1 bg-white border border-slate-200 rounded-lg p-2 text-center font-bold text-sm outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500">ì´ìœ¤(%)</label>
                                <input type="number" id="rate-profit" value="10" oninput="app.debounceUpdate()" class="w-full mt-1 bg-white border border-slate-200 rounded-lg p-2 text-center font-bold text-sm outline-none">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500">ë‹¨ìˆ˜ ì¡°ì •/í• ì¸(ì›)</label>
                            <input type="number" id="val-adjust" value="0" oninput="app.debounceUpdate()" class="w-full mt-1 bg-white border border-slate-200 rounded-lg p-2 text-right font-bold text-sm outline-none">
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-200 overflow-hidden flex flex-col w-full">
                    <div class="bg-slate-50 p-4 border-b">
                        <div class="flex flex-wrap gap-2 overflow-x-auto pb-1" id="category-tabs"></div>
                    </div>
                    <div class="p-6 bg-white border-b flex flex-col md:flex-row justify-between items-center gap-4">
                        <h2 class="font-black text-slate-800 text-sm flex items-center uppercase tracking-widest shrink-0 text-nowrap">
                            <span class="w-2 h-5 bg-blue-600 rounded-full mr-3"></span>
                            ITEM MASTER DATABASE
                        </h2>
                        <div class="flex space-x-2 w-full md:w-auto">
                            <input type="text" id="db-search" onkeyup="app.debounceRenderDB()" placeholder="í•­ëª© ê²€ìƒ‰..." class="flex-1 text-xs border border-slate-200 rounded-full px-6 py-3 outline-none focus:border-blue-500 shadow-sm min-w-0">
                            <button onclick="app.fetchExternalData()" id="sync-btn" class="bg-blue-50 text-blue-700 hover:bg-blue-100 px-5 py-3 rounded-full text-xs font-black transition-all border border-blue-100 flex items-center shrink-0">
                                <span id="sync-icon">ğŸ”„</span> <span class="ml-2">ë™ê¸°í™”</span>
                            </button>
                        </div>
                    </div>
                    <div class="h-[550px] overflow-y-auto custom-scroll w-full">
                        <table class="w-full text-left text-xs border-collapse table-fixed">
                            <thead class="bg-slate-50 sticky top-0 z-10 shadow-sm">
                                <tr class="text-slate-400 font-bold uppercase tracking-tighter">
                                    <th class="p-6 border-b w-auto">í’ˆëª… ë° ì œí’ˆ ìŠ¤í™</th>
                                    <th class="p-6 border-b text-center w-20">ë‹¨ìœ„</th>
                                    <th class="p-6 border-b text-right w-32">ë‹¨ê°€(ì›)</th>
                                    <th class="p-6 border-b text-center w-24">ë¡œì§</th>
                                    <th class="p-6 border-b text-center w-20">ì¶”ê°€</th>
                                </tr>
                            </thead>
                            <tbody id="db-tbody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="lg:col-span-4 space-y-6 min-w-0">
                <div class="bg-slate-900 rounded-[2rem] p-8 text-white shadow-2xl relative overflow-hidden">
                    <div class="absolute -top-4 -right-4 opacity-10 font-black text-8xl italic">AI</div>
                    <h3 class="text-xl font-black mb-4 flex items-center text-nowrap"><span class="text-blue-500 italic mr-2 text-2xl">Smart</span> Advisor</h3>
                    <div id="ai-response" class="text-xs text-slate-300 leading-relaxed mb-6 h-[180px] overflow-y-auto custom-scroll pr-4 italic border-l-2 border-orange-500/30 pl-4 whitespace-normal">ê²¬ì  í•­ëª©ì„ ì¶”ê°€í•˜ì‹  í›„ ì •ë°€ ë¶„ì„ì„ ìš”ì²­í•˜ì„¸ìš”.</div>
                    <button onclick="app.requestAiAnalysis()" id="ai-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl shadow-xl transition-all flex items-center justify-center space-x-3 transform active:scale-95 text-nowrap"><span>ì‹¤ì‹œê°„ ê²¬ì  ì •ë°€ ë¶„ì„ ìš”ì²­</span></button>
                </div>
                <div class="bg-white rounded-[2.5rem] shadow-xl border border-slate-200 overflow-hidden sticky top-24">
                    <div class="p-8 bg-blue-600 text-white flex justify-between items-end text-nowrap">
                        <div class="min-w-0">
                            <div class="text-[10px] font-bold opacity-60 tracking-widest uppercase mb-1">Estimated Total</div>
                            <div id="side-total" class="text-3xl font-black tracking-tighter truncate italic">0ì›</div>
                        </div>
                        <div class="text-right shrink-0">
                            <div class="text-[10px] font-bold opacity-60 uppercase mb-1">Items</div>
                            <div id="side-count" class="text-2xl font-black">0</div>
                        </div>
                    </div>
                    <div id="selected-list" class="p-4 max-h-[450px] overflow-y-auto custom-scroll space-y-3 bg-slate-50/50"></div>
                    <div class="p-6 bg-white border-t"><div class="h-[180px] w-full text-nowrap"><canvas id="budgetChart"></canvas></div></div>
                </div>
            </div>
        </main>
    </div>

    <div id="print-container" class="text-slate-900">
        <section class="print-page bg-white">
            <div class="flex justify-center border-b-[8px] border-slate-900 pb-3 mb-12"><h1 class="text-4xl font-black tracking-[1.5em] ">ê²¬ ì  ì„œ</h1></div>
            <div class="grid grid-cols-2 gap-12 mb-16 text-sm">
                <div class="space-y-6">
                    <div class="flex border-b border-slate-300 pb-2"><span class="w-20 font-black text-slate-400 uppercase text-[10px]">Date</span><span id="p1-date" class="font-bold"></span></div>
                    <div class="flex border-b border-slate-300 pb-2"><span class="w-20 font-black text-slate-400 uppercase text-[10px]">Client</span><span id="p1-client" class="font-black flex-1 wrap-text text-nowrap"></span></div>
                    <div class="flex border-b border-slate-300 pb-1"><span class="w-20 font-black text-slate-400 uppercase text-[8px]">Project</span><span class="flex-1 font-black italic uppercase text-blue-700">INTERIOR REMODELING PROJECT</span></div>
                </div>
                <div class="border-[2px] border-slate-900 p-3 relative">
                    <div class="absolute -top-2.5 left-5 bg-white px-1 font-black text-[9px] uppercase tracking-widest text-slate-500">Provider Information</div>
                    <table class="w-full text-xs">
                        <tr><td class="provider-label py-3 pr-2 w-12">ë“±ë¡ë²ˆí˜¸</td><td colspan="3" class="font-black text-sm">211 - 04 - 55758</td></tr>
                        <tr><td class="provider-label py-2 pr-2 w-12">ìƒ í˜¸</td><td class="font-black">í† í† ì¸í…Œë¦¬ì–´</td><td class="provider-label text-center w-12">ì„± ëª…</td><td class="text-right font-black pr-3">ì´ ë³‘ ë³µ (ì¸)</td></tr>
                        <tr><td class="provider-label py-2 pr-2 w-12">ì‚¬ì—…ì¥</td><td colspan="3" class="leading-tight wrap-text font-bold py-3 text-slate-800">ê²½ê¸°ë„ ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬ ë‚´ì •ë¡œ173ë²ˆê¸¸ 11 <br/>102í˜¸</td></tr>
                        <tr><td class="provider-label py-3 pr-2 w-12">ì—°ë½ì²˜</td><td colspan="3" class="font-bold tracking-tighter py-2"><span class="block leading-tight">TEL: 031-717-9045</span><span class="block leading-tight">FAX: 031-717-9049</span></td></tr>
                    </table>
                </div>
            </div>
            <div class="bg-slate-50 p-10 border-y-[4px] border-slate-900 mb-12">
                <div class="flex justify-between items-center mb-10"><div class="leading-tight"><div class="text-2xl font-black text-slate-400 uppercase">Grand Total</div><div class="text-[15px] font-bold text-slate-500 mt-1">ë¶€ê°€ì„¸(VAT) ë³„ë„</div></div><div class="text-right"><span id="p1-hangeul" class="text-1.5xl italic font-bold text-blue-800">ì¼ê¸ˆ ì˜ ì›ì •</span><div id="p1-total" class="text-5xl font-black tracking-tighter mt-2">0</div></div></div>
                <div class="grid grid-cols-4 gap-4 border-t border-slate-300 pt-8 text-xs text-center">
                    <div><div class="text-slate-400 font-bold uppercase mb-1">ì§ì ‘ ê³µì‚¬ë¹„</div><div id="p1-direct" class="font-black text-lg">0</div></div>
                    <div><div class="text-slate-400 font-bold uppercase mb-1">ê¸°ì—… ê²½ë¹„ (<span id="p1-rate-exp">0</span>%)</div><div id="p1-exp" class="font-black text-lg">0</div></div>
                    <div><div class="text-slate-400 font-bold uppercase mb-1">ê¸°ì—… ì´ìœ¤ (<span id="p1-rate-profit">0</span>%)</div><div id="p1-profit" class="font-black text-lg">0</div></div>
                    <div><div class="text-slate-400 font-bold uppercase mb-1">ë‹¨ìˆ˜ ì¡°ì •</div><div id="p1-adjust" class="font-black text-lg text-orange-600">0</div></div>
                </div>
            </div>
            <div class="text-[13px] space-y-1 text-slate-800 italic leading-relaxed font-medium pb-4 mt-auto">
                <p>1. ìœ„ì™€ ê°™ì´ ì¸í…Œë¦¬ì–´ ì‹œê³µ ê²¬ì ì„œë¥¼ ì œì¶œí•©ë‹ˆë‹¤.</p>
                <p>2. ê³µì‚¬ ì¼ì •ì€ í™•ì • í›„ ìƒí˜¸ í˜‘ì˜í•˜ë©°, í˜„ì¥ ì‹¤ì¸¡ ë°ì´í„°ì— ë”°ë¼ ìˆ˜ëŸ‰ì´ ì¼ë¶€ ë³€ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <p>3. ë³¸ ê²¬ì ì„œëŠ” ë°œí–‰ì¼ë¡œë¶€í„° 15ì¼ê°„ ìœ íš¨í•©ë‹ˆë‹¤.</p>
            </div>
        </section>

        <section class="print-page bg-white">
            <h2 class="page-header-title text-nowrap">01. ê³µì¢…ë³„ ìš”ì•½ ë‚´ì—­ì„œ (Summary)</h2>
            <table class="w-full border-collapse border-2 border-slate-900 text-xs">
                <thead class="bg-slate-100 uppercase font-black text-slate-600 text-nowrap">
                    <tr><th class="border border-slate-900 py-2 px-1 w-12 text-center">No</th><th class="border border-slate-900 py-2 px-4 text-left">ê³µ ì¢… ëª… (Category)</th><th class="border border-slate-900 py-2 px-4 text-right w-64">í•© ê³„ ê¸ˆ ì•¡ (Subtotal)</th><th class="border border-slate-900 py-2 px-4 w-40 text-center">ë¹„ ê³ </th></tr>
                </thead>
                <tbody id="p2-tbody"></tbody>
                <tfoot>
                    <tr class="bg-slate-50 font-black text-nowrap"><td colspan="2" class="py-3 text-center text-xs italic border-t border-slate-900 uppercase">Total</td><td id="p2-sum" class="py-3 px-4 text-right text-sm border-t border-slate-900">0</td><td class="border-t border-slate-900"></td></tr>
                </tfoot>
            </table>
        </section>

        <section class="print-page auto-height bg-white">
            <h2 class="page-header-title text-nowrap">02. ê³µì‚¬ ì„¸ë¶€ ë‚´ì—­ì„œ (Details)</h2>
            <table id="p3-table" class="w-full border-collapse detail-table">
                <thead class="text-nowrap"><tr><th class="w-10 text-center">No</th><th class="w-48 text-left">í’ˆëª… / ê³µì •</th><th class="text-left">ì§ì ‘ê³µì‚¬ë¹„ ìƒì„¸ ê·œê²© ë° ì‹œê³µ ì‚¬ì–‘</th><th class="w-12 text-center">ë‹¨ìœ„</th><th class="w-12 text-center">ìˆ˜ëŸ‰</th><th class="w-24 text-right">ë‹¨ê°€</th><th class="w-32 text-right">ê¸ˆì•¡</th></tr></thead>
            </table>
        </section>
    </div>

    <script>
        // ==================== ì•± ìƒíƒœ ê´€ë¦¬ ====================
        const app = {
            sheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT07Uf0iXXGQsjaIkcvhQmY0vJT2KvKBLDXucGKWja8kxLMDwyvrlhlMqBZCEjVh87JxVbzD2p0oQLw/pub?output=csv",
            MASTER_DB: [],
            selectedItems: [],
            budgetChart: null,
            activeCategory: "ê³µí†µ ê°€ì„¤",
            apiKey: "",
            basePrices: new Map(), // ì›ë³¸ ë‹¨ê°€ ì €ì¥ìš©
            debounceTimers: {},
            areaType: 'normal', // ë©´ì  íƒ€ì…: normal, extended, high
            areaMultipliers: {
                normal: 1.0,
                extended: 1.1,
                high: 1.2
            },
            orderCriteria: ["ê³µí†µ ê°€ì„¤", "ì² ê±° ê³µì‚¬", "ì„¤ë¹„ ê³µì‚¬", "ë°©ìˆ˜ ê³µì‚¬", "ë‹¨ì—´ ê³µì‚¬", "ì°½í˜¸ ê³µì‚¬", "ë„ì–´ ê³µì‚¬", "ëª©ê³µì‚¬", "ì „ê¸° ê³µì‚¬", "ì—ì–´ì»¨ ê³µì‚¬", "íƒ€ì¼ ê³µì‚¬", "ë„ë°° ê³µì‚¬", "ë§ˆë£¨ ê³µì‚¬", "ìš•ì‹¤ ê³µì‚¬", "ë„ì¥ ê³µì‚¬", "í•„ë¦„ ê³µì‚¬", "ê°€êµ¬ ê³µì‚¬", "ë§ˆê° ê³µì‚¬", "ê¸°íƒ€ ê³µì‚¬"]
        };

        // ==================== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ====================
        const utils = {
            // ë””ë°”ìš´ìŠ¤ í•¨ìˆ˜
            debounce(func, wait = 300) {
                return (...args) => {
                    clearTimeout(app.debounceTimers[func.name]);
                    app.debounceTimers[func.name] = setTimeout(() => func.apply(this, args), wait);
                };
            },

            // ìˆ«ìë¥¼ í•œê¸€ë¡œ ë³€í™˜
            numToKorean(num) {
                if (num === 0) return 'ì˜';
                const units = ['', 'ë§Œ', 'ì–µ', 'ì¡°'];
                const digits = ['', 'ì¼', 'ì´', 'ì‚¼', 'ì‚¬', 'ì˜¤', 'ìœ¡', 'ì¹ ', 'íŒ”', 'êµ¬'];
                const sUnits = ['', 'ì‹­', 'ë°±', 'ì²œ'];
                let res = '', uIdx = 0;
                while (num > 0) {
                    let sec = num % 10000, secRes = '';
                    for (let i = 0; i < 4; i++) {
                        let d = sec % 10;
                        if (d > 0) secRes = digits[d] + sUnits[i] + secRes;
                        sec = Math.floor(sec / 10);
                    }
                    if (secRes) res = secRes + units[uIdx] + ' ' + res;
                    num = Math.floor(num / 10000);
                    uIdx++;
                }
                return 'ì¼ê¸ˆ ' + res.trim() + 'ì›ì •';
            },

            // CSV íŒŒì‹± (ê°œì„ ëœ ë²„ì „)
            parseCSV(text) {
                const rows = [];
                let currentRow = [];
                let currentField = '';
                let inQuotes = false;

                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    const nextChar = text[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            currentField += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        currentRow.push(currentField.trim());
                        currentField = '';
                    } else if ((char === '\n' || char === '\r') && !inQuotes) {
                        if (currentField || currentRow.length > 0) {
                            currentRow.push(currentField.trim());
                            rows.push(currentRow);
                            currentRow = [];
                            currentField = '';
                        }
                        if (char === '\r' && nextChar === '\n') i++;
                    } else {
                        currentField += char;
                    }
                }
                if (currentField || currentRow.length > 0) {
                    currentRow.push(currentField.trim());
                    rows.push(currentRow);
                }
                return rows;
            },

            // ì•ˆì „í•œ ìˆ«ì ë³€í™˜
            safeParseInt(str, defaultValue = 0) {
                const num = parseInt(String(str).replace(/[^0-9]/g, '')) || defaultValue;
                return isNaN(num) ? defaultValue : num;
            },

            // ì•ˆì „í•œ ì‹¤ìˆ˜ ë³€í™˜
            safeParseFloat(str, defaultValue = 0) {
                const num = parseFloat(String(str)) || defaultValue;
                return isNaN(num) ? defaultValue : num;
            }
        };

        // ==================== ê³„ì‚° ë¡œì§ ëª¨ë“ˆ ====================
        const calculationLogic = {
            // ìˆ˜ëŸ‰ ê³„ì‚° (ë©´ì  íƒ€ì… ì ìš©)
            calculateQuantity(logic, size, areaType = 'normal') {
                const sizeNum = utils.safeParseFloat(size, 0);
                if (sizeNum <= 0) return 1;

                // ë©´ì  íƒ€ì…ë³„ ê³„ìˆ˜ ì ìš©
                const areaMultipliers = {
                    normal: 1.0,
                    extended: 1.1,
                    high: 1.2
                };
                const areaMultiplier = areaMultipliers[areaType] || 1.0;
                const adjustedSize = sizeNum * areaMultiplier;

                const logicMap = {
                    // ë²½ë©´ì  ê³„ì‚°
                    "WALL_10": () => Math.ceil(adjustedSize * 1.0),
                    "WALL_11": () => Math.ceil(adjustedSize * 1.1),
                    "WALL_12": () => Math.ceil(adjustedSize * 1.2),
                    "WALL_15": () => Math.ceil(adjustedSize * 1.5),
                    "WALL_17": () => Math.ceil(adjustedSize * 1.7),
                    "WALL_20": () => Math.ceil(adjustedSize * 2.0),
                    "WALL_25": () => Math.ceil(adjustedSize * 2.5),
                    "WALL_27": () => Math.ceil(adjustedSize * 2.7),
                    "WALL_30": () => Math.ceil(adjustedSize * 3.0),
                    "WALL_35": () => Math.ceil(adjustedSize * 3.5),
                    "WALL_40": () => Math.ceil(adjustedSize * 4.0),
                    "WALL_45": () => Math.ceil(adjustedSize * 4.5),
                    
                    // ë„ë°° ì¸ê±´ë¹„ (ì‹¤í¬ì§€)
                    "W_SILK_LABOR": () => Math.ceil((adjustedSize * 3.5) / 15),
                    "W_SILK_LABOR1": () => Math.ceil((adjustedSize * 3.5) / 15),  // All
                    "W_SILK_LABOR2": () => Math.ceil((adjustedSize * 2.5) / 15),  // ë²½ë§Œ
                    "W_SILK_LABOR3": () => Math.ceil((adjustedSize * 1.2) / 15),  // ì²œì¥ë§Œ
                    
                    // ë„ë°° ì¸ê±´ë¹„ (í•©ì§€)
                    "W_HAP_LABOR": () => Math.ceil((adjustedSize * 3.5) / 30),
                    "W_HAP_LABOR1": () => Math.ceil((adjustedSize * 3.5) / 30),  // All
                    "W_HAP_LABOR2": () => Math.ceil((adjustedSize * 2.5) / 30),  // ë²½ë§Œ
                    "W_HAP_LABOR3": () => Math.ceil((adjustedSize * 1.2) / 30),  // ì²œì¥ë§Œ
                    "W_HAP_RM_LABOR": () => Math.ceil((adjustedSize * 2.5) / 30),
                    
                    // ë„ë°° ì¸ê±´ë¹„ (ê³ ê¸‰ì§€)
                    "W_PREM_LABOR": () => Math.ceil((adjustedSize * 3.5) / 14),
                    "W_PREM_LABOR1": () => Math.ceil((adjustedSize * 3.5) / 14),  // All
                    "W_PREM_LABOR2": () => Math.ceil((adjustedSize * 2.5) / 14),  // ë²½ë§Œ
                    "W_PREM_LABOR3": () => Math.ceil((adjustedSize * 1.2) / 14),  // ì²œì¥ë§Œ
                    
                    // í‰ìˆ˜ ê¸°ë°˜
                    "PY_1X": () => adjustedSize,
                    "PY_10": () => Math.ceil(adjustedSize / 10),
                    "PY_K32": () => parseFloat((adjustedSize / 32).toFixed(2)),
                    
                    // ë°”ë‹¥ë©´ì 
                    "FLOOR_07": () => Math.ceil(adjustedSize * 0.7),
                    "FLOOR_08": () => Math.ceil(adjustedSize * 0.8),
                    "FLOOR_11": () => Math.ceil(adjustedSize * 1.1)
                };

                return logicMap[logic] ? logicMap[logic]() : 1;
            },

            // ë‹¨ê°€ ê³„ì‚° (FIXED ë¡œì§ - ë©´ì  íƒ€ì… ì ìš©)
            calculatePrice(logic, basePrice, size, areaType = 'normal') {
                const sizeNum = utils.safeParseFloat(size, 0);
                if (sizeNum <= 0) return basePrice;

                // ë©´ì  íƒ€ì…ë³„ ê³„ìˆ˜
                const areaMultipliers = {
                    normal: 1.0,
                    extended: 1.1,
                    high: 1.2
                };
                const areaMultiplier = areaMultipliers[areaType] || 1.0;
                const adjustedSize = sizeNum * areaMultiplier;

                // FIXED ë¡œì§ ì²˜ë¦¬
                if (logic.endsWith("_FIXED")) {
                    // íŠ¹ìˆ˜ ê³„ìˆ˜ ë¡œì§ë“¤
                    if (logic.includes("PY_07_FIXED") || logic.includes("FLOOR_07")) {
                        return Math.round(basePrice * adjustedSize * 0.7);
                    }
                    if (logic.includes("PY_08_FIXED") || logic.includes("FLOOR_08")) {
                        return Math.round(basePrice * adjustedSize * 0.8);
                    }
                    if (logic.includes("PY_11_FIXED") || logic.includes("FLOOR_11")) {
                        return Math.round(basePrice * adjustedSize * 1.1);
                    }
                    if (logic.includes("WALL_25") || logic.includes("PY_WL_WALL25")) {
                        return Math.round(basePrice * adjustedSize * 2.5);
                    }
                    if (logic.includes("WALL_35") || logic.includes("PY_WL_WALL35")) {
                        return Math.round(basePrice * adjustedSize * 3.5);
                    }
                    if (logic.includes("PY_MOLD") || logic.includes("PY_FN") || logic.includes("PY_K")) {
                        return Math.round(basePrice * adjustedSize * 1.0);
                    }
                    // ê¸°ë³¸ FIXED: í‰ìˆ˜ Ã— ë‹¨ê°€
                    return Math.round(basePrice * adjustedSize);
                }
                
                return basePrice;
            }
        };

        // ==================== ë©´ì  íƒ€ì… ê´€ë¦¬ ====================
        app.setAreaType = function(type) {
            app.areaType = type;
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.area-type-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-500', 'text-white', 'border-blue-500');
                btn.classList.add('bg-white', 'text-slate-600', 'border-slate-200');
            });
            
            const activeBtn = document.getElementById(`area-type-${type}`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-blue-500', 'text-white', 'border-blue-500');
                activeBtn.classList.remove('bg-white', 'text-slate-600', 'border-slate-200');
            }
            
            // ë©´ì  ê³„ìˆ˜ ì—…ë°ì´íŠ¸
            const multiplier = app.areaMultipliers[type];
            document.getElementById('area-multiplier').value = multiplier;
            
            app.syncAutoCalculations();
            app.updateActualSizeDisplay();
        };

        app.updateAreaMultiplier = function() {
            const multiplier = utils.safeParseFloat(document.getElementById('area-multiplier').value, 1.0);
            app.areaMultipliers[app.areaType] = multiplier;
            app.syncAutoCalculations();
            app.updateActualSizeDisplay();
        };

        app.getActualSize = function() {
            const baseSize = utils.safeParseFloat(document.getElementById('site-size').value, 0);
            const multiplier = app.areaMultipliers[app.areaType] || 1.0;
            return baseSize * multiplier;
        };

        app.updateActualSizeDisplay = function() {
            const actualSize = app.getActualSize();
            const display = document.getElementById('actual-size-display');
            if (display) {
                display.textContent = actualSize.toFixed(1);
            }
        };

        // ==================== ë°ì´í„° ê´€ë¦¬ ====================
        app.fetchExternalData = async function() {
            const btn = document.getElementById('sync-btn');
            const icon = document.getElementById('sync-icon');
            if (!btn) return;

            btn.disabled = true;
            btn.classList.add('animate-pulse');
            icon.textContent = 'â³';

            try {
                const response = await fetch(app.sheetUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const csvText = await response.text();
                const rows = utils.parseCSV(csvText);
                
                if (rows.length < 2) throw new Error('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');

                const newDB = [];
                const errors = [];
                
                rows.slice(1).forEach((cols, idx) => {
                    if (cols.length >= 5 && cols[0] !== "") {
                        try {
                            const basePrice = utils.safeParseInt(cols[4], 0);
                            const itemId = "CLOUD_" + idx;
                            
                            const item = {
                                id: itemId,
                                cat: cols[0].replace(/\*/g, '').trim(),
                                name: cols[1] || "ë¯¸ì§€ì •",
                                spec: cols[2] || "",
                                unit: cols[3] || "ì‹",
                                price: basePrice,
                                logic: (cols[5] || "MANUAL").trim(),
                                lTxt: cols[6] || "ìˆ˜ëŸ‰ì…ë ¥",
                                // ì¶”ê°€ ì»¬ëŸ¼ ì €ì¥
                                refPrice30: cols[7] ? utils.safeParseInt(cols[7], 0) : null,
                                pyPrice: cols[8] ? utils.safeParseFloat(cols[8], 0) : null,
                                note: cols[11] || ""
                            };

                            // ë¡œì§ ìœ íš¨ì„± ê²€ì‚¬
                            if (item.logic !== "MANUAL" && item.logic !== "FIXED" && 
                                !calculationLogic.calculateQuantity(item.logic, 30, 'normal') &&
                                !calculationLogic.calculatePrice(item.logic, basePrice, 30, 'normal')) {
                                errors.push(`í–‰ ${idx + 2}: ë¡œì§ "${item.logic}" ì²˜ë¦¬ ë¶ˆê°€`);
                            }

                            newDB.push(item);
                            // ì›ë³¸ ë‹¨ê°€ ì €ì¥
                            app.basePrices.set(itemId, basePrice);
                        } catch (e) {
                            errors.push(`í–‰ ${idx + 2}: íŒŒì‹± ì˜¤ë¥˜ - ${e.message}`);
                        }
                    }
                });
                
                // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
                if (errors.length > 0) {
                    console.warn('ë°ì´í„° íŒŒì‹± ê²½ê³ :', errors);
                    app.showNotification(`${errors.length}ê°œ í•­ëª©ì— ê²½ê³ ê°€ ìˆìŠµë‹ˆë‹¤.`, 'info');
                }

                if (newDB.length > 0) {
                    app.MASTER_DB = newDB;
                    document.getElementById('sync-status')?.classList.remove('hidden');
                    app.renderTabs();
                    app.renderDB();
                    app.showNotification('ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ', 'success');
                } else {
                    throw new Error('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error("Sheet Sync Error:", error);
                app.showNotification(`ë™ê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.classList.remove('animate-pulse');
                icon.textContent = 'ğŸ”„';
            }
        };

        // ==================== ë Œë”ë§ í•¨ìˆ˜ ====================
        app.renderTabs = function() {
            const container = document.getElementById('category-tabs');
            if (!container) return;

            const cats = [...new Set(app.MASTER_DB.map(i => i.cat))];
            cats.sort((a, b) => {
                const idxA = app.orderCriteria.indexOf(a);
                const idxB = app.orderCriteria.indexOf(b);
                return (idxA === -1 ? 99 : idxA) - (idxB === -1 ? 99 : idxB);
            });

            container.innerHTML = '';
            cats.forEach(c => {
                const btn = document.createElement('button');
                btn.className = `category-tab px-4 py-2 rounded-2xl text-[11px] font-black border-2 border-slate-100 transition-all shrink-0 ${app.activeCategory === c ? 'active' : 'bg-white text-slate-500 hover:bg-slate-100'}`;
                btn.textContent = c;
                btn.onclick = () => {
                    app.activeCategory = c;
                    app.renderTabs();
                    app.renderDB();
                };
                container.appendChild(btn);
            });
        };

        app.renderDB = function() {
            const tbody = document.getElementById('db-tbody');
            if (!tbody) return;

            const search = (document.getElementById('db-search')?.value || "").toLowerCase().trim();
            
            // ê²€ìƒ‰ì–´ ì •ê·œí™” (ë„ì–´ì“°ê¸°, íŠ¹ìˆ˜ë¬¸ì ì œê±°)
            const normalizeSearch = (text) => {
                return text.replace(/\s+/g, '').replace(/[^\wê°€-í£]/g, '').toLowerCase();
            };
            const normalizedSearch = normalizeSearch(search);
            
            const filtered = app.MASTER_DB.filter(i => {
                if (i.cat !== app.activeCategory) return false;
                
                if (!search) return true;
                
                // ëŒ€ì†Œë¬¸ì ë¬´ì‹œ, ë„ì–´ì“°ê¸° ë¬´ì‹œ ê²€ìƒ‰
                const nameNorm = normalizeSearch(i.name);
                const specNorm = normalizeSearch(i.spec);
                const catNorm = normalizeSearch(i.cat);
                
                return nameNorm.includes(normalizedSearch) || 
                       specNorm.includes(normalizedSearch) ||
                       catNorm.includes(normalizedSearch);
            });

            // ê¸°ì¡´ í–‰ ì œê±° í›„ ìƒˆë¡œ ìƒì„± (ì„±ëŠ¥ ìµœì í™”)
            tbody.innerHTML = '';

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="p-8 text-center text-slate-400 italic">
                            ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>`;
                return;
            }

            filtered.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-blue-50 transition cursor-pointer group fade-in';
                tr.onclick = () => app.addItem(item.id);

                // ë¡œì§ ìœ íš¨ì„± í‘œì‹œ
                const isValidLogic = item.logic === "MANUAL" || 
                                    item.logic === "FIXED" ||
                                    item.logic.endsWith("_FIXED") ||
                                    calculationLogic.calculateQuantity(item.logic, 30, 'normal') > 0;

                tr.innerHTML = `
                    <td class="p-6">
                        <div class="flex items-center gap-2 mb-1">
                            <div class="text-[9px] font-black text-blue-600 uppercase tracking-tighter text-nowrap">${item.cat}</div>
                            ${!isValidLogic ? '<span class="text-[8px] bg-red-500 text-white px-1.5 py-0.5 rounded font-bold">âš </span>' : ''}
                            ${item.note ? '<span class="text-[8px] bg-yellow-500 text-white px-1.5 py-0.5 rounded font-bold" title="' + item.note + '">ğŸ“Œ</span>' : ''}
                        </div>
                        <div class="font-bold text-slate-800 text-sm wrap-text">${item.name}</div>
                        <div class="text-[12pt] text-slate-700 wrap-text leading-tight">${item.spec}</div>
                    </td>
                    <td class="p-6 text-center font-bold text-slate-500 uppercase text-nowrap">${item.unit}</td>
                    <td class="p-6 text-right font-black text-blue-900 text-nowrap">${item.price.toLocaleString()}</td>
                    <td class="p-6 text-center text-nowrap">
                        <span class="formula-badge font-bold ${!isValidLogic ? 'text-red-600' : ''}" title="${item.logic}">${item.lTxt}</span>
                    </td>
                    <td class="p-6 text-center text-nowrap">
                        <button class="bg-blue-600 text-white w-8 h-8 rounded-xl font-bold shadow-md group-hover:bg-orange-500 transition-colors">ï¼‹</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        };

        // ==================== í•­ëª© ê´€ë¦¬ ====================
        app.addItem = function(id) {
            const item = app.MASTER_DB.find(i => i.id === id);
            if (!item) {
                app.showNotification('í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const existing = app.selectedItems.find(s => s.id === id);
            if (existing) {
                app.showNotification('ì´ë¯¸ ì¶”ê°€ëœ í•­ëª©ì…ë‹ˆë‹¤.', 'info');
                return;
            }

            const size = utils.safeParseFloat(document.getElementById('site-size').value, 0);
            const areaType = app.areaType || 'normal';
            const basePrice = app.basePrices.get(id) || item.price;

            // ë‹¨ê°€ ê³„ì‚° (ë©´ì  íƒ€ì… ì ìš©)
            let currentPrice = calculationLogic.calculatePrice(item.logic, basePrice, size, areaType);
            
            // ìˆ˜ëŸ‰ ê³„ì‚° (FIXEDê°€ ì•„ë‹Œ ê²½ìš°)
            let qty = 1;
            if (!item.logic.endsWith("_FIXED") && item.logic !== "FIXED" && item.logic !== "MANUAL") {
                qty = calculationLogic.calculateQuantity(item.logic, size, areaType);
            }

            // ë¡œì§ ì²˜ë¦¬ ì‹¤íŒ¨ ì‹œ ê²½ê³ 
            if (qty <= 0 || currentPrice <= 0) {
                console.warn(`í•­ëª© "${item.name}" ê³„ì‚° ì‹¤íŒ¨: ë¡œì§="${item.logic}", ìˆ˜ëŸ‰=${qty}, ë‹¨ê°€=${currentPrice}`);
            }

            app.selectedItems.push({
                ...item,
                qty: Math.max(1, qty),
                price: Math.max(0, currentPrice),
                basePrice: basePrice // ì›ë³¸ ë‹¨ê°€ ì €ì¥
            });

            app.updateAll();
            app.showNotification(`${item.name} ì¶”ê°€ë¨`, 'success');
        };

        app.syncAutoCalculations = function() {
            const size = utils.safeParseFloat(document.getElementById('site-size').value, 0);
            const areaType = app.areaType || 'normal';

            app.selectedItems.forEach(item => {
                const basePrice = item.basePrice || app.basePrices.get(item.id) || item.price;

                // ë‹¨ê°€ ì¬ê³„ì‚° (FIXED ë¡œì§)
                if (item.logic.endsWith("_FIXED") || item.logic === "FIXED") {
                    item.qty = 1;
                    item.price = calculationLogic.calculatePrice(item.logic, basePrice, size, areaType);
                } else if (item.logic === "MANUAL") {
                    // ìˆ˜ë™ ì…ë ¥ í•­ëª©ì€ ë³€ê²½í•˜ì§€ ì•ŠìŒ
                    item.price = basePrice;
                } else {
                    // ìˆ˜ëŸ‰ ì¬ê³„ì‚° (ë©´ì  íƒ€ì… ì ìš©)
                    item.qty = calculationLogic.calculateQuantity(item.logic, size, areaType);
                    item.price = basePrice; // ì›ë³¸ ë‹¨ê°€ ìœ ì§€
                }
            });

            app.updateAll();
        };

        app.updateQty = function(id, val) {
            const item = app.selectedItems.find(s => s.id === id);
            if (item) {
                item.qty = Math.max(0, utils.safeParseFloat(val, 0));
                app.updateAll();
            }
        };

        app.removeItem = function(id) {
            const item = app.selectedItems.find(s => s.id === id);
            if (item) {
                app.selectedItems = app.selectedItems.filter(s => s.id !== id);
                app.updateAll();
                app.showNotification(`${item.name} ì œê±°ë¨`, 'info');
            }
        };

        // ==================== ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ====================
        app.updateDashboard = function() {
            const list = document.getElementById('selected-list');
            const navTotal = document.getElementById('nav-total');
            const sideTotal = document.getElementById('side-total');
            const sideCount = document.getElementById('side-count');

            if (!list) return;

            if (app.selectedItems.length === 0) {
                list.innerHTML = '<div class="text-center py-20 text-slate-300 text-xs italic">ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>';
                navTotal.textContent = '0ì›';
                sideTotal.textContent = '0ì›';
                sideCount.textContent = '0';
                return;
            }

            let directTotal = 0;
            const fragment = document.createDocumentFragment();

            app.selectedItems.forEach((item, idx) => {
                const sub = item.price * item.qty;
                directTotal += sub;

                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-4 bg-white border border-slate-100 rounded-2xl shadow-sm m-card fade-in';
                div.style.animationDelay = `${idx * 0.05}s`;
                div.innerHTML = `
                    <div class="flex items-center min-w-0 mr-3">
                        <div class="drag-handle cursor-move p-2 mr-2 text-slate-400 hover:text-blue-600 font-bold text-lg shrink-0">â‹®â‹®</div>
                        <div class="overflow-hidden">
                            <div class="text-[9px] font-black text-blue-500 uppercase tracking-tighter">${item.cat}</div>
                            <div class="text-xs font-black truncate text-slate-900">${item.name}</div>
                            <div class="text-[10px] text-slate-700 font-bold truncate leading-tight">${item.spec}</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 shrink-0">
                        <input type="number" value="${item.qty}" onchange="app.updateQty('${item.id}', this.value)" class="w-12 border-none bg-slate-100 rounded-lg text-xs p-1.5 text-center font-bold">
                        <div class="text-xs font-black w-24 text-right text-slate-900">${sub.toLocaleString()}ì›</div>
                        <button onclick="app.removeItem('${item.id}')" class="text-slate-300 hover:text-red-500 ml-2">âœ•</button>
                    </div>`;
                fragment.appendChild(div);
            });

            list.innerHTML = '';
            list.appendChild(fragment);

            const rateExp = utils.safeParseFloat(document.getElementById('rate-exp').value, 0);
            const rateProfit = utils.safeParseFloat(document.getElementById('rate-profit').value, 0);
            const adjust = utils.safeParseInt(document.getElementById('val-adjust').value, 0);

            const exp = Math.round(directTotal * (rateExp / 100));
            const profit = Math.round(directTotal * (rateProfit / 100));
            const total = directTotal + exp + profit + adjust;
            const totalTxt = total.toLocaleString() + 'ì›';

            navTotal.textContent = totalTxt;
            sideTotal.textContent = totalTxt;
            sideCount.textContent = app.selectedItems.length;
        };

        // ==================== ì°¨íŠ¸ ê´€ë¦¬ ====================
        app.initChart = function() {
            const ctx = document.getElementById('budgetChart')?.getContext('2d');
            if (!ctx) return;

            app.budgetChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#0f172a', '#2563eb', '#f97316', '#10b981', '#fb923c', '#60a5fa', '#93c5fd'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '78%',
                    plugins: { legend: { display: false } }
                }
            });
        };

        app.updateChart = function() {
            if (!app.budgetChart) return;

            const cats = {};
            app.selectedItems.forEach(i => {
                cats[i.cat] = (cats[i.cat] || 0) + (i.price * i.qty);
            });

            app.budgetChart.data.labels = Object.keys(cats).map(l => 
                l.length > 10 ? l.substring(0, 10) + '...' : l
            );
            app.budgetChart.data.datasets[0].data = Object.values(cats);
            app.budgetChart.update('none'); // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ì—…ë°ì´íŠ¸
        };

        // ==================== ì¸ì‡„ ë·° ì—…ë°ì´íŠ¸ ====================
        app.updatePrintView = function() {
            const client = document.getElementById('site-name').value;
            document.getElementById('p1-client').textContent = client;
            document.getElementById('p1-date').textContent = new Date().toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            let directTotal = 0;
            const grouped = app.selectedItems.reduce((acc, item) => {
                if (!acc[item.cat]) acc[item.cat] = [];
                acc[item.cat].push(item);
                return acc;
            }, {});

            const sortedCats = Object.keys(grouped).sort((a, b) => {
                const idxA = app.orderCriteria.indexOf(a);
                const idxB = app.orderCriteria.indexOf(b);
                return (idxA === -1 ? 99 : idxA) - (idxB === -1 ? 99 : idxB);
            });

            const p2Tbody = document.getElementById('p2-tbody');
            p2Tbody.innerHTML = '';

            const p3Table = document.getElementById('p3-table');
            p3Table.querySelectorAll('tbody').forEach(tb => tb.remove());

            sortedCats.forEach((cat, catIdx) => {
                let catSum = 0;
                const newTbody = document.createElement('tbody');
                let catHtml = `<tr class="category-row"><td class="text-center font-bold">${catIdx + 1}</td><td colspan="6" class="font-black text-blue-800 tracking-wider">${cat}</td></tr>`;

                grouped[cat].forEach(item => {
                    const sub = item.price * item.qty;
                    catSum += sub;
                    directTotal += sub;

                    catHtml += `<tr>
                        <td class="text-center text-slate-400 opacity-50"></td>
                        <td class="font-black text-slate-900">${item.name}</td>
                        <td class="font-bold text-slate-700 wrap-text text-[9px]">${item.spec}</td>
                        <td class="text-center uppercase text-[8px]">${item.unit}</td>
                        <td class="text-center font-black">${item.qty}</td>
                        <td class="text-right">${item.price.toLocaleString()}</td>
                        <td class="text-right font-black">${sub.toLocaleString()}</td>
                    </tr>`;
                });

                catHtml += `<tr class="subtotal-row">
                    <td colspan="3"></td>
                    <td colspan="3" class="text-right text-[9px] font-bold italic uppercase tracking-tighter">ì†Œ ê³„ (SUBTOTAL)</td>
                    <td class="text-right font-black text-blue-900">${catSum.toLocaleString()}</td>
                </tr>`;

                newTbody.innerHTML = catHtml;
                p3Table.appendChild(newTbody);

                p2Tbody.innerHTML += `<tr>
                    <td class="border border-slate-900 py-1.5 text-center font-medium">${catIdx + 1}</td>
                    <td class="border border-slate-900 py-1.5 px-4 font-black">${cat}</td>
                    <td class="border border-slate-900 py-1.5 px-4 text-right font-black">${catSum.toLocaleString()}</td>
                    <td class="border border-slate-900 py-1.5 text-center text-slate-400 italic text-[10px]">ì¸ê±´ë¹„ ë° ìì¬ë¹„ í¬í•¨</td>
                </tr>`;
            });

            const rateExp = utils.safeParseFloat(document.getElementById('rate-exp').value, 0);
            const rateProfit = utils.safeParseFloat(document.getElementById('rate-profit').value, 0);
            const adjust = utils.safeParseInt(document.getElementById('val-adjust').value, 0);

            const exp = Math.round(directTotal * (rateExp / 100));
            const profit = Math.round(directTotal * (rateProfit / 100));
            const total = directTotal + exp + profit + adjust;

            document.getElementById('p1-direct').textContent = directTotal.toLocaleString();
            document.getElementById('p1-rate-exp').textContent = rateExp;
            document.getElementById('p1-exp').textContent = exp.toLocaleString();
            document.getElementById('p1-rate-profit').textContent = rateProfit;
            document.getElementById('p1-profit').textContent = profit.toLocaleString();
            document.getElementById('p1-adjust').textContent = adjust.toLocaleString();
            document.getElementById('p1-total').textContent = total.toLocaleString();
            document.getElementById('p1-hangeul').textContent = utils.numToKorean(total);
            document.getElementById('p2-sum').textContent = directTotal.toLocaleString();
        };

        // ==================== í†µí•© ì—…ë°ì´íŠ¸ ====================
        app.updateAll = function() {
            app.updateDashboard();
            app.updateChart();
            app.updatePrintView();
        };

        // ==================== ë””ë°”ìš´ìŠ¤ ë˜í¼ ====================
        app.debounceUpdate = utils.debounce(app.updateAll, 300);
        app.debounceRenderDB = utils.debounce(app.renderDB, 300);

        // ==================== AI ë¶„ì„ ====================
        app.requestAiAnalysis = async function() {
            if (app.selectedItems.length === 0) {
                app.showNotification('ë¶„ì„í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
                return;
            }

            const btn = document.getElementById('ai-btn');
            const aiBox = document.getElementById('ai-response');

            if (!btn || !aiBox) return;

            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span> ANALYZING...';

            const summary = app.selectedItems.map(i => 
                `${i.name}(${i.cat}): ${i.price}ì› x ${i.qty} = ${(i.price * i.qty).toLocaleString()}ì›`
            ).join('\n');

            try {
                if (!app.apiKey) {
                    throw new Error('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${app.apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: "ìˆ˜ì„ ì „ëµê°€ë¡œì„œ ë‹¤ìŒ ê²¬ì ì„ ì •ë°€ ë¶„ì„í•˜ê³  ìœ„í—˜ ìš”ì†Œì™€ ê²½ìŸë ¥ì„ êµµê²Œ í‘œì‹œí•´ í•œêµ­ì–´ë¡œ ì¡°ì–¸í•´ì¤˜:\n" + summary
                                }]
                            }]
                        })
                    }
                );

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                if (data.candidates && data.candidates[0]) {
                    aiBox.innerHTML = data.candidates[0].content.parts[0].text
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong class="text-blue-600">$1</strong>');
                } else {
                    throw new Error('ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜');
                }
            } catch (e) {
                aiBox.innerHTML = `<span class="text-red-400">ë¶„ì„ ì‹¤íŒ¨: ${e.message}</span>`;
                console.error('AI Analysis Error:', e);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>ì‹¤ì‹œê°„ ê²¬ì  ì •ë°€ ë¶„ì„ ìš”ì²­</span>';
            }
        };

        // ==================== ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ====================
        app.saveToLocal = function() {
            try {
                const data = {
                    siteName: document.getElementById('site-name').value,
                    siteSize: document.getElementById('site-size').value,
                    areaType: app.areaType,
                    areaMultipliers: app.areaMultipliers,
                    rateExp: document.getElementById('rate-exp').value,
                    rateProfit: document.getElementById('rate-profit').value,
                    valAdjust: document.getElementById('val-adjust').value,
                    selectedItems: app.selectedItems,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('totoEstimate', JSON.stringify(data));
                app.showNotification('ì €ì¥ ì™„ë£Œ', 'success');
            } catch (e) {
                app.showNotification('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
            }
        };

        app.loadFromLocal = function() {
            try {
                const saved = localStorage.getItem('totoEstimate');
                if (!saved) {
                    app.showNotification('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
                    return;
                }

                const data = JSON.parse(saved);
                document.getElementById('site-name').value = data.siteName || '';
                document.getElementById('site-size').value = data.siteSize || '';
                
                // ë©´ì  íƒ€ì… ë³µì›
                if (data.areaType) {
                    app.areaType = data.areaType;
                    app.setAreaType(data.areaType);
                }
                if (data.areaMultipliers) {
                    app.areaMultipliers = { ...app.areaMultipliers, ...data.areaMultipliers };
                    document.getElementById('area-multiplier').value = app.areaMultipliers[app.areaType] || 1.0;
                }
                
                document.getElementById('rate-exp').value = data.rateExp || '5';
                document.getElementById('rate-profit').value = data.rateProfit || '10';
                document.getElementById('val-adjust').value = data.valAdjust || '0';

                if (data.selectedItems && Array.isArray(data.selectedItems)) {
                    app.selectedItems = data.selectedItems;
                    // basePrice ë³µì›
                    app.selectedItems.forEach(item => {
                        if (!item.basePrice) {
                            item.basePrice = app.basePrices.get(item.id) || item.price;
                        }
                    });
                }

                app.syncAutoCalculations();
                app.updateActualSizeDisplay();
                app.showNotification('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ', 'success');
            } catch (e) {
                app.showNotification('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + e.message, 'error');
            }
        };

        // ==================== ì•Œë¦¼ ì‹œìŠ¤í…œ ====================
        app.showNotification = function(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 ${colors[type] || colors.info} text-white px-6 py-3 rounded-xl shadow-xl z-50 fade-in`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        };

        // ==================== ì´ˆê¸°í™” ====================
        app.init = function() {
            app.initChart();
            app.initSortable();
            app.setAreaType('normal'); // ë©´ì  íƒ€ì… ì´ˆê¸°í™”
            app.fetchExternalData();
            
            // ìë™ ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            const autoLoad = localStorage.getItem('totoEstimateAutoLoad');
            if (autoLoad === 'true') {
                app.loadFromLocal();
            }
        };

        app.initSortable = function() {
            const el = document.getElementById('selected-list');
            if (!el) return;

            Sortable.create(el, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                onEnd: (evt) => {
                    const item = app.selectedItems.splice(evt.oldIndex, 1)[0];
                    app.selectedItems.splice(evt.newIndex, 0, item);
                    app.updateAll();
                }
            });
        };

        // ==================== í˜ì´ì§€ ë¡œë“œ ====================
        window.onload = app.init;

        // ==================== ìë™ ì €ì¥ (ì„ íƒì‚¬í•­) ====================
        setInterval(() => {
            if (app.selectedItems.length > 0) {
                app.saveToLocal();
            }
        }, 60000); // 1ë¶„ë§ˆë‹¤ ìë™ ì €ì¥
    </script>
</body>
</html>
